# CR5 æ‹–æ‹½ç¤ºæ•™ - pi0 æ•°æ®é‡‡é›†

## ğŸ¯ ä¸€é”®é‡‡é›† pi0 è®­ç»ƒæ•°æ®

åªéœ€è¿è¡Œ `simple_drag_demo.py`ï¼Œå°±å¯ä»¥é€šè¿‡æ‹–æ‹½ç¤ºæ•™è‡ªåŠ¨é‡‡é›† pi0 æ ¼å¼çš„è®­ç»ƒæ•°æ®ï¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
cd /home/huang/learn_arm_robot/openpi/examples/cr5/CR5_TCP_test

# è¿è¡Œæ‹–æ‹½ç¤ºæ•™
python simple_drag_demo.py
```

å°±è¿™ä¹ˆç®€å•ï¼ç¨‹åºä¼šï¼š
1. âœ… è‡ªåŠ¨è¿æ¥æœºå™¨äººå’Œç›¸æœº
2. âœ… å¼€å¯æ‹–æ‹½æ¨¡å¼
3. âœ… å®æ—¶è®°å½•å…³èŠ‚è§’åº¦å’Œç›¸æœºå›¾åƒï¼ˆ10 Hzï¼‰
4. âœ… è‡ªåŠ¨è½¬æ¢è§’åº¦â†’å¼§åº¦
5. âœ… è‡ªåŠ¨è®¡ç®—å…³èŠ‚é€Ÿåº¦
6. âœ… ä¿å­˜ä¸º pi0 è®­ç»ƒæ ¼å¼

## ğŸ“ ä½¿ç”¨æµç¨‹

### 1. å¯åŠ¨ç¨‹åº

```bash
python simple_drag_demo.py
```

### 2. ç­‰å¾…åˆå§‹åŒ–

ç¨‹åºä¼šè‡ªåŠ¨ï¼š
- è¿æ¥æœºå™¨äººï¼ˆ192.168.5.1ï¼‰
- åˆå§‹åŒ–ç›¸æœº
- ä½¿èƒ½æœºå™¨äºº
- å¼€å¯æ‹–æ‹½æ¨¡å¼

çœ‹åˆ° `âœ“ æ‹–æ‹½æ¨¡å¼å·²å¼€å¯!` åå³å¯å¼€å§‹ç¤ºæ•™ã€‚

### 3. æ‹–æ‹½ç¤ºæ•™

- æ‰‹åŠ¨æ‹–åŠ¨æœºå™¨äººå®Œæˆä»»åŠ¡åŠ¨ä½œ
- ç¨‹åºè‡ªåŠ¨è®°å½•æ•°æ®ï¼ˆ10 Hzï¼‰
- å±å¹•ä¼šæ˜¾ç¤ºå½“å‰å…³èŠ‚è§’åº¦å’Œä½ç½®

ç¤ºä¾‹è¾“å‡ºï¼š
```
è®°å½•ç‚¹   1: å…³èŠ‚[ 36.6Â°,  4.7Â°,  1.1Â°,  0.4Â°, -4.6Â°,  0.0Â°] ä½ç½®[ 145.0,-378.4,1143.3] | ç›¸æœº: âœ“
è®°å½•ç‚¹   2: å…³èŠ‚[ 36.8Â°,  4.8Â°,  1.2Â°,  0.4Â°, -4.5Â°,  0.0Â°] ä½ç½®[ 146.2,-379.1,1144.1] | ç›¸æœº: âœ“
è®°å½•ç‚¹   3: å…³èŠ‚[ 37.1Â°,  4.9Â°,  1.3Â°,  0.5Â°, -4.4Â°,  0.0Â°] ä½ç½®[ 147.5,-380.2,1145.0] | ç›¸æœº: âœ“
...
```

### 4. ç»“æŸé‡‡é›†

æŒ‰ `Ctrl+C` åœæ­¢ï¼Œç¨‹åºä¼šè‡ªåŠ¨ï¼š
- åœæ­¢æ‹–æ‹½æ¨¡å¼
- è®¡ç®—å…³èŠ‚é€Ÿåº¦
- ä¿å­˜æ•°æ®ä¸º pi0 æ ¼å¼
- æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯å’Œä¸‹ä¸€æ­¥æŒ‡å¼•

## ğŸ“Š è‡ªåŠ¨å¤„ç†çš„æ•°æ®è½¬æ¢

æ‚¨çš„åŸå§‹æ•°æ®ï¼ˆè§’åº¦åˆ¶ï¼‰ï¼š
```json
{
  "J1": 36.647,  // åº¦
  "J2": 4.704,
  ...
}
```

è‡ªåŠ¨è½¬æ¢ä¸º pi0 æ ¼å¼ï¼ˆå¼§åº¦åˆ¶ + é€Ÿåº¦ï¼‰ï¼š
```json
{
  "observation.state": [0.6397, 0.0821, ...],  // å¼§åº¦
  "action": [-0.0523, 0.1234, ..., 0.0]  // å…³èŠ‚é€Ÿåº¦(rad/s) + å¤¹çˆª
}
```

## ğŸ¯ é‡‡é›†å»ºè®®

### ä¸€æ¬¡é‡‡é›†åº”è¯¥åŒ…å«ä»€ä¹ˆï¼Ÿ

- **å®Œæ•´ä»»åŠ¡è½¨è¿¹**ï¼šä»åˆå§‹ä½ç½®åˆ°å®Œæˆä»»åŠ¡
- **æ—¶é•¿**ï¼š5-10 ç§’æœ€ä½³ï¼ˆ50-100 å¸§ï¼‰
- **é€Ÿåº¦**ï¼šå¹³æ»‘è‡ªç„¶ï¼Œé¿å…çªç„¶åŠ é€Ÿ

### éœ€è¦å¤šå°‘æ•°æ®ï¼Ÿ

| ä»»åŠ¡å¤æ‚åº¦ | æ¨èé‡‡é›†æ¬¡æ•° |
|-----------|------------|
| ç®€å•ï¼ˆå¦‚æŠ“å–å›ºå®šä½ç½®ï¼‰ | 10-20 æ¬¡ |
| ä¸­ç­‰ï¼ˆå¦‚æŠ“å–ä¸åŒä½ç½®ï¼‰ | 30-50 æ¬¡ |
| å¤æ‚ï¼ˆå¦‚ç»„è£…ä»»åŠ¡ï¼‰ | 50+ æ¬¡ |

### å¦‚ä½•é‡‡é›†å¤šä¸ª episodeï¼Ÿ

**æ–¹æ³• 1ï¼šå¤šæ¬¡è¿è¡Œï¼ˆæ¨èï¼‰**
```bash
# ç¬¬ä¸€æ¬¡
python simple_drag_demo.py
# ... æ‹–æ‹½ç¤ºæ•™ ...
# Ctrl+C ä¿å­˜

# ç¬¬äºŒæ¬¡
python simple_drag_demo.py
# ... æ‹–æ‹½ç¤ºæ•™ ...
# Ctrl+C ä¿å­˜

# ... é‡å¤ ...
```

æ¯æ¬¡è¿è¡Œä¼šåˆ›å»ºæ–°çš„æ•°æ®é›†æ–‡ä»¶å¤¹ã€‚

**æ–¹æ³• 2ï¼šæ‰¹é‡åˆå¹¶**
```bash
# é‡‡é›†å¤šä¸ªæ•°æ®é›†åï¼Œæ‰‹åŠ¨åˆå¹¶åˆ°ä¸€ä¸ªç›®å½•
# ç„¶åç”¨è½¬æ¢è„šæœ¬ç»Ÿä¸€å¤„ç†
```

## ğŸ“ æ•°æ®å­˜å‚¨

### ç›®å½•ç»“æ„

```
lerobot_dataset_20241014_153000/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ chunk-000/
â”‚       â””â”€â”€ file-000000.parquet   # å¸§æ•°æ®
â”œâ”€â”€ meta/
â”‚   â”œâ”€â”€ info.json                  # æ•°æ®é›†ä¿¡æ¯
â”‚   â”œâ”€â”€ episodes.parquet           # Episode å…ƒæ•°æ®
â”‚   â”œâ”€â”€ stats.json                 # ç»Ÿè®¡ä¿¡æ¯
â”‚   â””â”€â”€ tasks.parquet              # ä»»åŠ¡åˆ—è¡¨
â”œâ”€â”€ videos/
â”‚   â”œâ”€â”€ observation.images.camera_color/
â”‚   â”‚   â””â”€â”€ episode_000000.mp4
â”‚   â””â”€â”€ observation.images.camera_depth/
â”‚       â””â”€â”€ episode_000000.mp4
â””â”€â”€ README.md
```

### æ•°æ®æ ¼å¼

**è§‚æµ‹ç©ºé—´**ï¼š
- `observation.state`: 6 ä¸ªå…³èŠ‚ä½ç½®ï¼ˆå¼§åº¦ï¼‰
- `observation.cartesian_position`: æœ«ç«¯ç¬›å¡å°”åæ ‡
- `observation.images.camera_color`: å½©è‰²å›¾åƒ
- `observation.images.camera_depth`: æ·±åº¦å›¾åƒ

**åŠ¨ä½œç©ºé—´**ï¼š
- 7 ç»´ï¼š6 ä¸ªå…³èŠ‚é€Ÿåº¦ï¼ˆrad/sï¼‰+ 1 ä¸ªå¤¹çˆªä½ç½®
- è‡ªåŠ¨ä»å…³èŠ‚ä½ç½®åºåˆ—è®¡ç®—é€Ÿåº¦

## ğŸ”§ é…ç½®ä¿®æ”¹

### ä¿®æ”¹æœºå™¨äºº IP

ç¼–è¾‘ `simple_drag_demo.py` ç¬¬ 11 è¡Œï¼š

```python
ROBOT_IP = "192.168.5.1"  # æ”¹ä¸ºæ‚¨çš„æœºå™¨äºº IP
```

### ä¿®æ”¹é‡‡é›†é¢‘ç‡

ç¼–è¾‘ç¬¬ 108 è¡Œï¼š

```python
lerobot_saver = LeRobotDatasetSaver(
    repo_id=repo_id,
    fps=10,  # æ”¹ä¸ºæ‚¨éœ€è¦çš„é¢‘ç‡ï¼ˆæ¨è 10 Hzï¼‰
    robot_type="dobot_cr5"
)
```

å’Œç¬¬ 257 è¡Œï¼š

```python
time.sleep(0.1)  # å¯¹åº” 10 Hzï¼Œå¦‚æœæ”¹ä¸º 5 Hz åˆ™æ”¹ä¸º 0.2
```

### ä¿®æ”¹ä»»åŠ¡æè¿°

ç¼–è¾‘ç¬¬ 118 è¡Œï¼š

```python
lerobot_saver.start_episode(task_name="teach_drag")  # æ”¹ä¸ºæ‚¨çš„ä»»åŠ¡åç§°
```

ä¾‹å¦‚ï¼š
```python
lerobot_saver.start_episode(task_name="pick_red_cube")
lerobot_saver.start_episode(task_name="place_in_box")
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç¨‹åºå¯åŠ¨åæ— æ³•æ‹–åŠ¨æœºå™¨äºº

**åŸå› **ï¼šæœºå™¨äººæœªæˆåŠŸä½¿èƒ½æˆ–æ‹–æ‹½æ¨¡å¼æœªå¼€å¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ç¨‹åºè¾“å‡ºæ˜¯å¦æœ‰é”™è¯¯
# ç¡®ä¿çœ‹åˆ°ï¼š
# âœ“ ä½¿èƒ½æœºå™¨äºº...
# âœ“ æ‹–æ‹½æ¨¡å¼å·²å¼€å¯!
```

### Q2: ç›¸æœºåˆå§‹åŒ–å¤±è´¥

```
âš  æ·±åº¦ç›¸æœºåˆå§‹åŒ–å¤±è´¥ï¼Œå°†åªè®°å½•æœºå™¨äººæ•°æ®
```

**è§£å†³**ï¼š
```bash
# 1. æ£€æŸ¥ç›¸æœºè¿æ¥
realsense-viewer

# 2. æ£€æŸ¥ USB æƒé™
sudo chmod 666 /dev/bus/usb/*/*

# 3. é‡æ–°æ’æ‹”ç›¸æœº

# 4. å¦‚æœä¸éœ€è¦ç›¸æœºæ•°æ®ï¼Œå¯ä»¥å¿½ç•¥æ­¤è­¦å‘Š
#    ç¨‹åºä¼šç»§ç»­è®°å½•æœºå™¨äººæ•°æ®
```

### Q3: æ•°æ®ä¿å­˜ä½ç½®åœ¨å“ªï¼Ÿ

åœ¨ `CR5_TCP_test` ç›®å½•ä¸‹ï¼š
```bash
ls -lh lerobot_dataset_*
```

### Q4: å¦‚ä½•éªŒè¯æ•°æ®æ ¼å¼ï¼Ÿ

```bash
# æ£€æŸ¥æ•°æ®é›†ç»“æ„
tree lerobot_dataset_20241014_153000 -L 2

# æŸ¥çœ‹å…ƒæ•°æ®
cat lerobot_dataset_20241014_153000/meta/info.json | jq

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
cat lerobot_dataset_20241014_153000/meta/stats.json | jq
```

### Q5: è§’åº¦è½¬å¼§åº¦æ˜¯å¦æ­£ç¡®ï¼Ÿ

ç¨‹åºå·²è‡ªåŠ¨å¤„ç†ï¼æ£€æŸ¥ä¿å­˜çš„æ•°æ®ï¼š

```bash
# æ‰“å¼€ Python
python3

# åŠ è½½æ•°æ®
import pandas as pd
df = pd.read_parquet('lerobot_dataset_xxx/data/chunk-000/file-000000.parquet')

# æŸ¥çœ‹å…³èŠ‚ä½ç½®ï¼ˆåº”è¯¥åœ¨ Â±3.14 èŒƒå›´å†…ï¼‰
print(df['observation.state'].iloc[0])
# è¾“å‡ºåº”è¯¥ç±»ä¼¼: [0.6397, 0.0821, 0.0187, 0.0064, -0.0794, 0.0]

# æŸ¥çœ‹å…³èŠ‚é€Ÿåº¦
print(df['action'].iloc[0])
# è¾“å‡ºåº”è¯¥ç±»ä¼¼: [-0.0523, 0.1234, 0.0321, 0.0, -0.0123, 0.0, 0.0]
```

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šå¾®è°ƒè®­ç»ƒ

### é‡‡é›†å¤šä¸ª episodes å

å‡è®¾æ‚¨å·²ç»è¿è¡Œäº† 10 æ¬¡ `simple_drag_demo.py`ï¼Œæœ‰ 10 ä¸ªæ•°æ®é›†æ–‡ä»¶å¤¹ï¼š

```bash
lerobot_dataset_20241014_153000/
lerobot_dataset_20241014_154000/
lerobot_dataset_20241014_155000/
...
```

### æ–¹æ³• 1ï¼šåˆ†åˆ«è®­ç»ƒï¼ˆæ¨èï¼‰

ç›´æ¥ä½¿ç”¨å•ä¸ªæ•°æ®é›†å¾®è°ƒï¼š

```bash
cd /home/huang/learn_arm_robot/openpi

python scripts/train_pytorch.py \
    --pretrained-checkpoint pi05_droid \
    --dataset-repo-id ./examples/cr5/CR5_TCP_test/lerobot_dataset_20241014_153000 \
    --output-dir ./outputs/cr5_finetuned \
    --num-epochs 10 \
    --batch-size 8 \
    --use-lora \
    --lora-rank 8
```

### æ–¹æ³• 2ï¼šåˆå¹¶è®­ç»ƒ

å¦‚æœæƒ³åˆå¹¶å¤šä¸ªæ•°æ®é›†ï¼š

```bash
# 1. åˆ›å»ºåˆå¹¶ç›®å½•
mkdir -p combined_dataset/data
mkdir -p combined_dataset/videos/observation.images.camera_color
mkdir -p combined_dataset/videos/observation.images.camera_depth

# 2. åˆå¹¶æ•°æ®æ–‡ä»¶
# ï¼ˆè¿™éœ€è¦å†™è„šæœ¬å¤„ç†ï¼Œæˆ–ä½¿ç”¨æˆ‘ä»¬çš„è½¬æ¢å·¥å…·ï¼‰

# 3. ç„¶åè®­ç»ƒ
python scripts/train_pytorch.py \
    --pretrained-checkpoint pi05_droid \
    --dataset-repo-id ./examples/cr5/combined_dataset \
    --output-dir ./outputs/cr5_finetuned \
    --num-epochs 20 \
    --batch-size 8 \
    --use-lora \
    --lora-rank 8
```

## ğŸ“– æŠ€æœ¯ç»†èŠ‚

### å·²ä¿®æ”¹çš„æ–‡ä»¶

1. **lerobot_dataset_saver.py**
   - âœ… æ·»åŠ è§’åº¦â†’å¼§åº¦è‡ªåŠ¨è½¬æ¢
   - âœ… æ·»åŠ å…³èŠ‚é€Ÿåº¦è®¡ç®—
   - âœ… åŠ¨ä½œç©ºé—´æ”¹ä¸º 7 ç»´ï¼ˆ6 é€Ÿåº¦ + 1 å¤¹çˆªï¼‰

2. **simple_drag_demo.py**
   - âœ… ä½¿ç”¨æ–°çš„ä¿å­˜å™¨åˆå§‹åŒ–æ–¹å¼
   - âœ… æ·»åŠ  pi0 æ ¼å¼è¯´æ˜è¾“å‡º

### æ•°æ®å¤„ç†æµç¨‹

```
åŸå§‹æ•°æ®é‡‡é›†
    â†“
[è§’åº¦åˆ¶, 10Hz]
    â†“
è‡ªåŠ¨è½¬æ¢ï¼ˆadd_frameï¼‰
    â†“
[å¼§åº¦åˆ¶å­˜å‚¨]
    â†“
Episode ç»“æŸï¼ˆsave_episodeï¼‰
    â†“
è®¡ç®—é€Ÿåº¦ï¼ˆ_compute_joint_velocitiesï¼‰
    â†“
[é€Ÿåº¦åŠ¨ä½œ]
    â†“
ä¿å­˜ Parquetï¼ˆfinalize_datasetï¼‰
    â†“
pi0 è®­ç»ƒæ ¼å¼
```

## ğŸ‰ æ€»ç»“

ç°åœ¨æ‚¨åªéœ€ï¼š

```bash
# 1. è¿è¡Œæ‹–æ‹½ç¤ºæ•™ï¼ˆé‡å¤ 10-50 æ¬¡ï¼‰
python simple_drag_demo.py

# 2. å¼€å§‹å¾®è°ƒ
cd /home/huang/learn_arm_robot/openpi
python scripts/train_pytorch.py \
    --pretrained-checkpoint pi05_droid \
    --dataset-repo-id ./examples/cr5/CR5_TCP_test/lerobot_dataset_xxx \
    --use-lora
```

å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ğŸš€
